import{u as L,a as U,r as o,j as e,L as S,y as d}from"./index-CDtZe3id.js";import{c as V}from"./courseService-BSeO5xSq.js";import{s as A}from"./subjectService-FmAgODbn.js";import{n as R}from"./nivelService-D0XCMSzS.js";import{u as $}from"./userService-BeE_nVnS.js";import{c as z}from"./coverService-mfvIq_ty.js";import{C}from"./CustomButton-BHk0TsfB.js";import{u as O}from"./index.esm-CYe7NKTW.js";import{o as T,c as B,d as J,f as P,a as m}from"./index.esm-DVNFl3iM.js";const M=B().shape({title:m().required("El título es requerido"),description:m(),author:m().required("El autor es requerido"),subject:m().required("La materia es requerida"),nivel:m().required("El nivel es requerido"),isPublished:P(),isGuestViewable:P(),coverImage:J().nullable()}),te=()=>{const j=L(),{user:t,isAuthenticated:u,hasRole:c}=U(),[x,n]=o.useState(!0),[F,k]=o.useState([]),[I,E]=o.useState([]),[D,g]=o.useState([]),[p,y]=o.useState(null),{register:s,handleSubmit:_,formState:{errors:a},setValue:N,watch:q}=O({resolver:T(M),defaultValues:{isPublished:!1,isGuestViewable:!1}}),b=q("coverImage");o.useEffect(()=>{u?(async()=>{try{n(!0);const h=[...await A.getSubjects()].sort((f,v)=>f.name.localeCompare(v.name));k(h);const l=await R.getNiveles();if(E(l),c(["admin"])){const v=(await $.getUsers()).filter(w=>w.role==="teacher"||w.role==="admin");g(v)}else c(["teacher"])&&g([t]);t&&(t.role==="teacher"||t.role==="admin")&&N("author",t.id)}catch(i){console.error("Error fetching data for course creation:",i),d.error("Error al cargar datos necesarios para crear el curso.")}finally{n(!1)}})():n(!1)},[t,u,c,N]),o.useEffect(()=>{if(b&&b[0]){const r=b[0];y(URL.createObjectURL(r))}else y(null);return()=>{p&&URL.revokeObjectURL(p)}},[b]);const G=async r=>{if(!u||!c(["admin","teacher"])){d.error("No tienes permiso para crear cursos.");return}if(!t||!t.id){d.error("ID de usuario no disponible. Por favor, intenta recargar la página o iniciar sesión de nuevo."),n(!1);return}n(!0);try{let i=null;if(r.coverImage&&r.coverImage[0]){const l=new FormData;l.append("image",r.coverImage[0]),l.append("name",`cover_${Date.now()}`),l.append("isGeneric","false"),l.append("idUser",t.id),i=(await z.createCover(l))._id}const h={...r,cover:i||void 0};await V.createCourse(h),d.success("Curso creado exitosamente. Será visible una vez aprobado por un administrador."),j("/admin/courses")}catch(i){console.error("Error creating course:",i),d.error(i.response?.data?.message||"Error al crear el curso.")}finally{n(!1)}};return x?e.jsxs("div",{className:"pt-20 flex flex-col items-center justify-center min-h-[calc(100vh-80px)] bg-bg-primary text-text-primary",children:[e.jsx(S,{}),e.jsx("p",{className:"mt-4",children:"Cargando formulario..."})]}):!u||!c(["admin","teacher"])?e.jsxs("div",{className:"pt-20 p-8 min-h-[calc(100vh-80px)] bg-bg-primary text-text-primary text-center",children:[e.jsx("h1",{className:"text-3xl font-bold mb-4 text-red-500",children:"Acceso Denegado"}),e.jsx("p",{className:"text-lg",children:"No tienes permiso para crear cursos."})]}):e.jsx("div",{className:"mt-28 p-8 min-h-[calc(100vh-80px)] bg-bg-primary text-text-primary",children:e.jsxs("div",{className:"max-w-[1024px] mx-auto",children:[e.jsx("h1",{className:"text-3xl font-bold mb-6 text-center w-full",children:"Crear Nuevo Curso"}),e.jsx("div",{className:"bg-bg-secondary p-8 rounded-lg shadow-lg w-full max-w-2xl mx-auto border border-border-color",children:e.jsxs("form",{onSubmit:_(G),className:"flex flex-col gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-text-primary text-sm font-bold mb-2",htmlFor:"title",children:"Título:"}),e.jsx("input",{type:"text",id:"title",...s("title"),className:"w-full px-3 py-2 border rounded-md bg-input-bg text-text-primary border-input-border"}),a.title&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:a.title.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-text-primary text-sm font-bold mb-2",htmlFor:"description",children:"Descripción:"}),e.jsx("textarea",{id:"description",...s("description"),className:"w-full px-3 py-2 border rounded-md bg-input-bg text-text-primary border-input-border",rows:"4"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-text-primary text-sm font-bold mb-2",htmlFor:"author",children:"Autor:"}),e.jsxs("select",{id:"author",...s("author"),className:"w-full px-3 py-2 border rounded-md bg-input-bg text-text-primary border-input-border",children:[e.jsx("option",{value:"",children:"Selecciona un autor"}),D.map(r=>e.jsxs("option",{value:r._id||r.id,children:[r.name," ",r.last_name]},r._id||r.id))]}),a.author&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:a.author.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-text-primary text-sm font-bold mb-2",htmlFor:"subject",children:"Materia:"}),e.jsxs("select",{id:"subject",...s("subject"),className:"w-full px-3 py-2 border rounded-md bg-input-bg text-text-primary border-input-border",children:[e.jsx("option",{value:"",children:"Selecciona una materia"}),F.map(r=>e.jsx("option",{value:r._id,children:r.name},r._id))]}),a.subject&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:a.subject.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-text-primary text-sm font-bold mb-2",htmlFor:"nivel",children:"Nivel:"}),e.jsxs("select",{id:"nivel",...s("nivel"),className:"w-full px-3 py-2 border rounded-md bg-input-bg text-text-primary border-input-border",children:[e.jsx("option",{value:"",children:"Selecciona un nivel"}),I.map(r=>e.jsx("option",{value:r._id,children:r.name},r._id))]}),a.nivel&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:a.nivel.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-text-primary text-sm font-bold mb-2",htmlFor:"coverImage",children:"Imagen de Portada (PNG/JPG opcional):"}),e.jsx("input",{type:"file",id:"coverImage",...s("coverImage"),accept:".png, .jpg, .jpeg",className:"w-full px-3 py-2 border rounded-md bg-input-bg text-text-primary border-input-border file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-accent-primary file:text-white hover:file:bg-blue-700"}),p&&e.jsxs("div",{className:"mt-4",children:[e.jsx("p",{className:"text-sm text-text-secondary mb-2",children:"Previsualización de la imagen:"}),e.jsx("img",{src:p,alt:"Previsualización de Portada",className:"max-w-xs h-auto rounded-md shadow-md"})]})]}),c(["admin"])&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"isPublished",...s("isPublished"),className:"form-checkbox h-5 w-5 text-accent-primary rounded"}),e.jsx("label",{className:"text-text-primary text-sm",htmlFor:"isPublished",children:"Publicado"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"isGuestViewable",...s("isGuestViewable"),className:"form-checkbox h-5 w-5 text-accent-primary rounded"}),e.jsx("label",{className:"text-text-primary text-sm",htmlFor:"isGuestViewable",children:"Visible para Invitados"})]})]}),e.jsxs("div",{className:"flex justify-end gap-4 mt-4",children:[e.jsx(C,{variant:"secondary",className:"cursor-pointer",onClick:()=>j("/admin/courses"),disabled:x,children:"Cancelar"}),e.jsx(C,{variant:"primary",className:"cursor-pointer",type:"submit",disabled:x,children:x?e.jsx(S,{}):"Crear Curso"})]})]})})]})})};export{te as default};
