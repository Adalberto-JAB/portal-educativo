import{b as X,u as Y,a as Z,r as s,y as m,j as e,L as G,f as ee,D as te,J as se,K as re}from"./index-CDtZe3id.js";import{c as U}from"./courseService-BSeO5xSq.js";import{s as ae}from"./subjectService-FmAgODbn.js";import{n as ie}from"./nivelService-D0XCMSzS.js";import{u as le}from"./userService-BeE_nVnS.js";import{c as oe}from"./coverService-mfvIq_ty.js";import{l as N}from"./lessonService-DhDsuAxs.js";import{C as w}from"./CustomButton-BHk0TsfB.js";import{S as ce}from"./sweetalert2.esm.all-CH_YVA8w.js";import{u as ne}from"./index.esm-CYe7NKTW.js";import{o as de,c as me,d as xe,f as C,a as p}from"./index.esm-DVNFl3iM.js";const ue=me().shape({title:p().required("El título es requerido"),description:p(),author:p(),subject:p().required("La materia es requerida"),nivel:p().required("El nivel es requerido"),isPublished:C(),isGuestViewable:C(),isApproved:C(),coverImage:xe().nullable()}),Se=()=>{const{id:i}=X(),c=Y(),{user:x,hasRole:b}=Z(),[h,f]=s.useState(!0),[V,B]=s.useState([]),[q,R]=s.useState([]),[T,z]=s.useState([]),[S,L]=s.useState([]),[v,E]=s.useState(null),[k,J]=s.useState(""),[F,M]=s.useState(null),{register:l,handleSubmit:O,formState:{errors:o},setValue:r,watch:g}=ne({resolver:de(ue)}),P=b(["admin","teacher"]),u=b(["admin"]),j=g("coverImage"),_=s.useCallback(async()=>{try{f(!0);const t=await U.getCourseById(i),a=x&&t.author&&t.author._id===x.id;if(b(["teacher"])&&!u&&!a){m.error("No tienes permiso para editar este curso."),c("/my-courses");return}const n=typeof t.nivel=="object"&&t.nivel!==null?t.nivel._id:t.nivel;r("title",t.title||""),r("description",t.description||""),r("author",t.author?._id||""),r("subject",t.subject?._id||""),r("nivel",n||""),r("isPublished",t.isPublished||!1),r("isGuestViewable",t.isGuestViewable||!1),r("isApproved",t.isApproved||!1),t.cover&&J(`https://portal-educativo-jab.onrender.com/api/covers/${t.cover._id}`);const[d,I]=await Promise.all([ae.getSubjects(),ie.getNiveles()]),Q=[...d].sort(($,y)=>$.name.localeCompare(y.name));if(B(Q),R(I),u){const y=(await le.getUsers()).filter(D=>D.role==="teacher"||D.role==="admin");z(y)}const W=await N.getLessons(i);L(W)}catch(t){console.error("Error fetching data for course edit:",t),m.error("Error al cargar datos del curso para edición."),M("No se pudo cargar el curso para edición.")}finally{f(!1)}},[i,u,x,c,b,r]);s.useEffect(()=>{_()},[_]),s.useEffect(()=>{if(j&&j[0]){const t=j[0];E(URL.createObjectURL(t))}else E(null);return()=>{v&&URL.revokeObjectURL(v)}},[j]);const K=async t=>{if(!P){m.error("No tienes permiso para modificar cursos.");return}f(!0);try{let a=g("cover");if(t.coverImage&&t.coverImage[0]){const d=new FormData;d.append("image",t.coverImage[0]),d.append("name",`cover_${Date.now()}`),d.append("isGeneric","false"),d.append("idUser",x.id),a=(await oe.createCover(d))._id}const n={...t,cover:a||void 0};await U.updateCourse(i,n),m.success("Curso actualizado exitosamente."),c("/admin/courses")}catch(a){console.error("Error updating course:",a),m.error(a.response?.data?.message||"Error al actualizar el curso.")}finally{f(!1)}},H=s.useCallback(t=>{ce.fire({title:"¿Estás seguro?",text:"¡No podrás revertir esta acción!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Sí, ¡elimínalo!",cancelButtonText:"Cancelar"}).then(async a=>{if(a.isConfirmed)try{await N.deleteLesson(t),m.success("Lección eliminada exitosamente.");const n=await N.getLessons(i);L(n)}catch(n){m.error(n.response?.data?.message||"Error al eliminar la lección.")}})},[i]),A=u||x&&x.id===g("author");return h?e.jsxs("div",{className:"pt-20 flex flex-col items-center justify-center min-h-[calc(100vh-80px)] bg-bg-primary text-text-primary",children:[e.jsx(G,{}),e.jsx("p",{className:"mt-4",children:"Cargando curso para edición..."})]}):F?e.jsxs("div",{className:"pt-20 p-8 min-h-[calc(100vh-80px)] bg-bg-primary text-text-primary text-center",children:[e.jsx("h1",{className:"text-3xl font-bold mb-4 text-red-500",children:"Error"}),e.jsx("p",{className:"text-lg",children:F})]}):P?e.jsx("div",{className:"mt-28 p-8 min-h-[calc(100vh-80px)] bg-bg-primary text-text-primary",children:e.jsxs("div",{className:"max-w-[1024px] mx-auto",children:[e.jsx("h1",{className:"text-3xl font-bold mb-6 text-center w-full",children:"Editar Curso"}),e.jsxs("div",{className:"bg-bg-secondary p-8 rounded-lg shadow-lg w-full max-w-2xl mx-auto border border-border-color",children:[e.jsxs("form",{onSubmit:O(K),className:"flex flex-col gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-text-primary text-sm font-bold mb-2",htmlFor:"title",children:"Título:"}),e.jsx("input",{type:"text",id:"title",...l("title"),className:"w-full px-3 py-2 border rounded-md bg-input-bg text-text-primary border-input-border"}),o.title&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:o.title.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-text-primary text-sm font-bold mb-2",htmlFor:"description",children:"Descripción:"}),e.jsx("textarea",{id:"description",...l("description"),className:"w-full px-3 py-2 border rounded-md bg-input-bg text-text-primary border-input-border",rows:"4"})]}),u&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-text-primary text-sm font-bold mb-2",htmlFor:"author",children:"Autor:"}),e.jsxs("select",{id:"author",...l("author"),className:"w-full px-3 py-2 border rounded-md bg-input-bg text-text-primary border-input-border",children:[e.jsx("option",{value:"",children:"Selecciona un autor"}),T.map(t=>e.jsxs("option",{value:t._id,children:[t.name," ",t.last_name]},t._id))]}),o.author&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:o.author.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-text-primary text-sm font-bold mb-2",htmlFor:"subject",children:"Materia:"}),e.jsxs("select",{id:"subject",...l("subject"),className:"w-full px-3 py-2 border rounded-md bg-input-bg text-text-primary border-input-border",children:[e.jsx("option",{value:"",children:"Selecciona una materia"}),V.map(t=>e.jsx("option",{value:t._id,children:t.name},t._id))]}),o.subject&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:o.subject.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-text-primary text-sm font-bold mb-2",htmlFor:"nivel",children:"Nivel:"}),e.jsxs("select",{id:"nivel",...l("nivel"),className:"w-full px-3 py-2 border rounded-md bg-input-bg text-text-primary border-input-border",children:[e.jsx("option",{value:"",children:"Selecciona un nivel"}),q.map(t=>e.jsx("option",{value:t._id,children:t.name},t._id))]}),o.nivel&&e.jsx("p",{className:"text-red-500 text-xs mt-1",children:o.nivel.message})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-text-primary text-sm font-bold mb-2",htmlFor:"coverImage",children:"Imagen de Portada (PNG/JPG opcional):"}),e.jsx("input",{type:"file",id:"coverImage",...l("coverImage"),accept:".png, .jpg, .jpeg",className:"w-full px-3 py-2 border rounded-md bg-input-bg text-text-primary border-input-border file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-accent-primary file:text-white hover:file:bg-blue-700"}),(v||k)&&e.jsxs("div",{className:"mt-4",children:[e.jsx("p",{className:"text-sm text-text-secondary mb-2",children:"Previsualización de la imagen:"}),e.jsx("img",{src:v||k,alt:"Previsualización de Portada",className:"max-w-xs h-auto rounded-md shadow-md"})]})]}),u&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"isPublished",...l("isPublished"),className:"form-checkbox h-5 w-5 text-accent-primary rounded"}),e.jsx("label",{className:"text-text-primary text-sm",htmlFor:"isPublished",children:"Publicado"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"isGuestViewable",...l("isGuestViewable"),className:"form-checkbox h-5 w-5 text-accent-primary rounded"}),e.jsx("label",{className:"text-text-primary text-sm",htmlFor:"isGuestViewable",children:"Visible para Invitados"})]})]}),e.jsxs("div",{className:"flex justify-end gap-4 mt-4",children:[e.jsx(w,{variant:"secondary",onClick:()=>c("/admin/courses"),disabled:h,children:"Cancelar"}),e.jsx(w,{variant:"primary",type:"submit",disabled:h,children:h?e.jsx(G,{}):"Guardar Cambios"})]})]}),e.jsxs("div",{className:"mt-8 border-t border-border-color pt-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-text-primary mb-4",children:"Lecciones del Curso"}),A&&e.jsx("div",{className:"mb-4",children:e.jsxs(w,{variant:"primary",onClick:()=>c(`/admin/courses/${i}/lessons/create`),children:[e.jsx(ee,{className:"mr-2"})," Añadir Nueva Lección"]})}),S.length===0?e.jsx("p",{className:"text-text-secondary",children:"No hay lecciones para este curso aún."}):e.jsx("ul",{className:"space-y-3",children:S.map(t=>e.jsxs("li",{className:"bg-bg-primary p-4 rounded-lg shadow-sm border border-border-color flex items-center justify-between",children:[e.jsxs("span",{className:"text-text-primary font-medium",children:[t.order,". ",t.title]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("button",{onClick:()=>c(`/lessons/${t._id}`),className:"text-blue-500 hover:text-blue-700 text-xl",title:"Ver Lección",children:e.jsx(te,{})}),A&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>c(`/admin/courses/${i}/lessons/edit/${t._id}`),className:"text-yellow-500 hover:text-yellow-700 text-xl",title:"Editar Lección",children:e.jsx(se,{})}),e.jsx("button",{onClick:()=>H(t._id),className:"text-red-500 hover:text-red-700 text-xl",title:"Eliminar Lección",children:e.jsx(re,{})})]})]})]},t._id))})]})]})]})}):e.jsxs("div",{className:"pt-20 p-8 min-h-[calc(100vh-80px)] bg-bg-primary text-text-primary text-center",children:[e.jsx("h1",{className:"text-3xl font-bold mb-4 text-red-500",children:"Acceso Denegado"}),e.jsx("p",{className:"text-lg",children:"No tienes permiso para editar cursos."})]})};export{Se as default};
